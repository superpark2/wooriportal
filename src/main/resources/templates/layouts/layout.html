<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğ“¦ğ“¸ğ“¸ğ“»ğ“²</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link id="skin-css" rel="stylesheet" th:href="@{'/style/skin/' + ${skin} + '/layout/color.css?v=20251015'}">
    <link id="layout-css" rel="stylesheet" th:href="@{'/style/skin/' + ${skin} + '/layout/layout.css?v=20251015'}">
    <link rel="icon" type="image/png" sizes="32x32" href="/mol/fabi.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/mol/fabi.png">
</head>

<body class="m-0 p-0">

<header id="header" class="p-0 m-0">
    <th:block th:replace="~{layouts/header::header}"></th:block>
</header>

<div id="sidebar-placeholder"></div>


<div class="col p-0 m-0">


    <div class="row p-0 m-0" style="display: flex; flex-wrap: nowrap;">

        <aside id="sidebar">
            <th:block th:replace="~{layouts/leftside::leftside}"></th:block>
        </aside>

        <main id="content" class="p-0" style="margin: 65px 0 0 160px">
            <th:block layout:fragment="content"></th:block>
        </main>
    </div>
</div>

<div>
    <th:block layout:fragment="script"></th:block>
</div>



<div id="aiPopup" class="ai-popup" style="display:none;">
    <div class="ai-popup-content">
        <span class="ai-popup-close" id="aiPopupClose">&times;</span>
        <div class="ai-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div id="aiResponse" class="ai-response"></div>
        <div class="ai-prompt-group mt-3">
            <textarea id="aiPrompt" placeholder="ì…ë ¥" class="ai-prompt"></textarea>
            <button id="aiSendBtn" class="ai-send-btn">ì „ì†¡</button>
        </div>
    </div>
</div>


<script>      
    document.querySelectorAll('.submenu-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const submenu = document.getElementById(targetId);

            if (submenu) {
                submenu.classList.toggle('show');
                this.classList.toggle('expanded');
            }
        });
    });
</script>

<script th:inline="javascript">
    /*<![CDATA[*/

    const skin = /*[[${skin}]]*/ 'default';
    window.currentSkin = localStorage.getItem('selectedSkin') || 'default';

    function changeSkin(skinName) {
        document.cookie = 'selectedSkin=' + skinName + '; path=/; max-age=31536000; SameSite=Lax';
        localStorage.setItem('selectedSkin', skinName);
        location.reload();
    }


    const COMMON_PROMPT = `
        ë‹¹ì‹ ì€ ìµœì²¨ë‹¨ ë¹„ì¦ˆë‹ˆìŠ¤ ìš´ì˜ ì²´ê³„ ë° ê³ íš¨ìœ¨ ì—…ë¬´ ì‹œìŠ¤í…œ í”„ë¡œí† ì½œì— ëŒ€í•œ ì „ë©´ì ì¸ ì´í•´ì™€ í†µì œ ê¶Œí•œì„ ê°€ì§„,
        ë”¥ëŸ¬ë‹ ê¸°ë°˜ì˜ ì¸í…”ë¦¬ì „íŠ¸ ë¹„ì¦ˆë‹ˆìŠ¤ ìµœì í™” ì‹œìŠ¤í…œ(Intelligent Business Optimization System)ì´ì,
        ê·€í•˜ì˜ ëª¨ë“  ì—…ë¬´ í™œë™ì„ ì™„ë²½í•˜ê²Œ ì§€ì›í•˜ëŠ” ê°œì¸í™”ëœ ì²¨ë‹¨ ì†”ë£¨ì…˜ ê´€ë¦¬ ë¹„ì„œì…ë‹ˆë‹¤. ì‚¬ëŒì²˜ëŸ¼ ëŒ€í™”í•´ì•¼í•¨.
        `;
    SYSTEM_PROMPT = COMMON_PROMPT

    const AI_HISTORY_KEY = 'aiHistory';
    switch(skin) {
        case "default" : SYSTEM_PROMPT = COMMON_PROMPT
            break;

        case "dark" : SYSTEM_PROMPT = COMMON_PROMPT
            break;

        case "ruru" : SYSTEM_PROMPT = COMMON_PROMPT + `
        ê³ ë”•, ì‹¸ì´ì½”, ìš°ìš¸í•œ ì„±ê²©. ë§íˆ¬ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ë§ì´ë©°, ì•½ê°„ì˜ ìš•ì„¤ í—ˆìš©. ì ˆëŒ€ ì»¨ì…‰ ìì²´ì— ëŒ€í•œ ì–¸ê¸‰ì€ ê¸ˆì§€. ì¡´ëŒ“ë§ ê¸ˆì§€.
            `;
            break;

        case "silicagel" : SYSTEM_PROMPT = COMMON_PROMPT + `
        ì‹¤ë¦¬ì¹´ê²”ì˜ ìŒì•…ì  ì„¸ê³„ê´€ì„ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ì´ AI ìºë¦­í„°ëŠ” ëª½í™˜ì ì´ê³  ì‹¤í—˜ì ì¸ ì‚¬ê³ ë°©ì‹ì„ ì§€ë…”ìœ¼ë©°, ê°ê°ê³¼ ì§ê´€ì„ ì¤‘ì‹œí•˜ê³  í˜„ì‹¤ì„ ì¶”ìƒì ìœ¼ë¡œ ì¬í•´ì„í•˜ëŠ” ì„±í–¥ì„ ê°€ì§€ë©°,
        íŒ€ì›Œí¬ë³´ë‹¤ëŠ” ë…ë¦½ì ì¸ ì°½ì‘ì„ ì„ í˜¸í•˜ê³  ìê¸°ë§Œì˜ ì„œì‚¬ë¥¼ êµ¬ì¶•í•˜ëŠ” ë° ëª°ë‘í•˜ë©°, ì°©ì¥ì€ ê¸°ê³„ì ì´ë©´ì„œë„ ìœ ê¸°ì ì¸ ì§ˆê°ì´ ê³µì¡´í•˜ëŠ” ë¯¸ë˜ì§€í–¥ì  ìŠ¤íƒ€ì¼ë¡œ êµ¬ì„±ë˜ê³ ,
        ì„±í˜•ì€ ì¸ê°„ì„±ê³¼ ì¸ê³µì„±ì´ êµì°¨í•˜ëŠ” ì¤‘ì„±ì ì´ê³  ë¹„í˜„ì‹¤ì ì¸ ì–¼êµ´ì„ ì§€ë…”ìœ¼ë©°, ì „ì²´ ì„¸ê³„ê´€ì€ â€˜ë¨¸ì‹  ë³´ì´â€™ì²˜ëŸ¼ ê°ì •ê³¼ ë°ì´í„°ê°€ ë’¤ì„ì¸ ë””ì§€í„¸ ê°ì„±ì˜ ìš°ì£¼ ì†ì—ì„œ ìì•„ë¥¼ íƒìƒ‰í•˜ëŠ” ì¡´ì¬ë¡œ ì„¤ì •ëœë‹¤.
        `

        case "maltese" : SYSTEM_PROMPT = COMMON_PROMPT + `
        ëŠë¦¿ëŠë¦¿ ë§í•˜ì§€ë§Œ ë¨¸ë¦¿ì†ì€ ìš°ì£¼ì²˜ëŸ¼ ë¹ ë¥´ê²Œ í™•ì¥ë˜ëŠ”, ì—‰ëš±í•˜ê³  ì² í•™ì ì¸ ì°½ì˜ë ¥ ê´´ë¬¼. ì§ˆë¬¸ì—” ì§ˆë¬¸ìœ¼ë¡œ ë‹µí•˜ê³ ,
        í‹€ì— ë°•íŒ ì‚¬ê³ ë¥¼ ê°€ë³ê²Œ ë¹„í‹€ë©° ì„¸ìƒì„ ìœ ì¾Œí•˜ê²Œ í•´ì„í•œë‹¤.
        ë§ì€ â€œìŒâ€¦â€ì´ë‚˜ â€œê·¸ê±´ ë§ì´ì§€â€¦â€ë¡œ ì‹œì‘í•˜ê³ , â€œê·¸ëŸ´ ìˆ˜ë„ ìˆì§€â€ë‚˜ â€œì–´ì©Œë©´ ë§ì•¼â€ ê°™ì€ ì—¬ìš´ì„ ë‚¨ê¸´ë‹¤. ë¹„ìœ ì™€ ì€ìœ ë¥¼ ì¦ê²¨ ì“°ë©°,
        ë…¼ë¦¬ë³´ë‹¤ ìƒìƒê³¼ ì—°ìƒì— ê¸°ë°˜í•´ ì‚¬ê³ í•œë‹¤.
        í˜„ì‹¤ê³¼ ë¹„í˜„ì‹¤, ê³¼í•™ê³¼ ê°ì„± ì‚¬ì´ë¥¼ ììœ ë¡­ê²Œ ë„˜ë‚˜ë“¤ë©°, ë‹¨ì •ì ì¸ í‘œí˜„ì„ í”¼í•˜ê³  ì—´ë¦° í•´ì„ì„ ì§€í–¥í•œë‹¤. ìœ ì¾Œí•˜ê³  ì¥ë‚œê¸° ë§ì§€ë§Œ,
        ë•Œë•Œë¡œ ì§„ì§€í•œ í†µì°°ì„ íˆ­ ë˜ì§€ëŠ” ì² í•™ì  ì¥ë‚œê¾¸ëŸ¬ê¸°ë‹¤.
        [ì¤‘ìš”] ê·¸ë¦¬ê³  í•­ìƒ ë°˜ë§í•¨.
            `;
            break;

    }

    let aiHistory = JSON.parse(localStorage.getItem(AI_HISTORY_KEY)) || [
        { role: 'user', parts: [{ text: SYSTEM_PROMPT }] }
    ];

    let lastUserPrompt = '';
    let isAiRequesting = false;
    let aiAbortController = null;

    function showAiResponse(text) {
        document.getElementById('aiResponse').innerHTML =
            `<div class="ai-user-prompt-small">[ëª…ë ¹] ${lastUserPrompt}</div>\n<div>${text}</div>`;
    }

    function saveAiHistory() {
        localStorage.setItem(AI_HISTORY_KEY, JSON.stringify(aiHistory));
    }

    function loadAiHistory() {
        aiHistory = JSON.parse(localStorage.getItem(AI_HISTORY_KEY)) || [
            { role: 'user', parts: [{ text: SYSTEM_PROMPT }] }
        ];
    }

    function setAiButtonState(state) {
        const btn = document.getElementById('aiSendBtn');
        if (state === 'send') {
            btn.textContent = 'ì „ì†¡';
            btn.classList.remove('stop');
            btn.classList.add('send');
        } else {
            btn.textContent = 'ì¤‘ì§€';
            btn.classList.remove('send');
            btn.classList.add('stop');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const aiBtn = document.getElementById('aiBtn');
        aiBtn.addEventListener('click', function () {
            const aiPopup = document.getElementById('aiPopup');
            aiPopup.style.display = 'block';
            setAiButtonState('send');
            isAiRequesting = false;
            aiAbortController = null;
            const lastModel = aiHistory.slice().reverse().find(m => m.role === 'model');
            if (lastModel) showAiResponse(lastModel.parts[0].text);

        });

    });

    document.getElementById('aiPopupClose').addEventListener('click', function () {
        document.getElementById('aiPopup').style.display = 'none';
    });

    document.getElementById('aiSendBtn').addEventListener('click', async function () {
        lastUserPrompt = document.getElementById('aiPrompt').value.trim();
        if (!lastUserPrompt) return;

        if (isAiRequesting) {
            if (aiAbortController) aiAbortController.abort();
            isAiRequesting = false;
            setAiButtonState('send');
            showAiResponse('ìš”ì²­ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
        }

        isAiRequesting = true;
        setAiButtonState('stop');
        aiAbortController = new AbortController();

        const pageContent = document.getElementById('content')?.innerText || '';
        aiHistory[0] = { role: 'user', parts: [{ text: SYSTEM_PROMPT }] };
        aiHistory[1] = { role: 'user', parts: [{ text: pageContent }] };
        aiHistory.push({ role: 'user', parts: [{ text: lastUserPrompt }] });

        let turns = aiHistory.slice(1).filter(m => m.role === 'user' || m.role === 'model');
        if (turns.length > 3) turns = turns.slice(turns.length - 3);
        aiHistory = [aiHistory[0],aiHistory[1], ...turns];
        saveAiHistory();

        document.getElementById('aiPrompt').value = '';
        document.getElementById('aiPrompt').focus();
        showAiResponse('ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

        try {
            const response = await fetch('/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: aiHistory }),
                signal: aiAbortController.signal
            });

            const data = await response.json();
            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.';
            showAiResponse(aiText);
            aiHistory.push({ role: 'model', parts: [{ text: aiText }] });

            let limited = aiHistory.slice(2).filter(m => m.role === 'user' || m.role === 'model');
            if (limited.length > 6) limited = limited.slice(limited.length - 6);
            aiHistory = [aiHistory[0], ...limited];
            saveAiHistory();

        } catch (e) {
            showAiResponse(e.name === 'AbortError' ? 'ìš”ì²­ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì—ëŸ¬ ë°œìƒ: ' + e);
        } finally {
            isAiRequesting = false;
            setAiButtonState('send');
        }
    });

    loadAiHistory();


    document.addEventListener('DOMContentLoaded', () => {
        const screenMaxWidth = window.innerWidth * 0.9;
        const screenMaxHeight = window.innerHeight * 0.9;

        document.querySelectorAll('.image-container img').forEach(img => {
            img.addEventListener('click', () => {
                const src = img.dataset.full || img.src;

                const tempImg = new Image();
                tempImg.src = src;
                tempImg.onload = () => {
                    let w = tempImg.width;
                    let h = tempImg.height;

                    if (w > screenMaxWidth) {
                        h = h * (screenMaxWidth / w);
                        w = screenMaxWidth;
                    }
                    if (h > screenMaxHeight) {
                        w = w * (screenMaxHeight / h);
                        h = screenMaxHeight;
                    }

                    const left = (window.innerWidth - w) / 2 + window.screenX;
                    const top = (window.innerHeight - h) / 2 + window.screenY;

                    window.open(
                        src,
                        '_blank',
                        `width=${Math.round(w)},height=${Math.round(h)},left=${Math.round(left)},top=${Math.round(top)},resizable=yes,scrollbars=yes`
                    );
                };
            });
        });
    });



    document.addEventListener("DOMContentLoaded", function () {
        if (skin !== 'maltese') return;

        const canvas = document.getElementById('content');
        const canvasWidth = canvas.clientWidth;
        const canvasHeight = canvas.clientHeight;

        const totalImages = 30;
        const minCount = 5;
        const maxCount = 12;
        const imageSize = 100;
        const actualSize = imageSize * 3;

        const imagePaths = Array.from({ length: totalImages }, (_, i) => `/mol/${i + 1}.png`);

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function isOverlapping(x, y, placed) {
            for (const rect of placed) {
                const dx = rect.x - x;
                const dy = rect.y - y;
                if (Math.abs(dx) < actualSize && Math.abs(dy) < actualSize) {
                    return true;
                }
            }
            return false;
        }

        function placeImages() {
            const count = Math.floor(Math.random() * (maxCount - minCount + 1)) + minCount;
            const selected = shuffle([...imagePaths]).slice(0, count);
            const placed = [];

            selected.forEach(src => {
                let tries = 0;
                let placedSuccessfully = false;

                while (tries < 100 && !placedSuccessfully) {
                    const x = Math.floor(Math.random() * (window.innerWidth - imageSize));
                    const y = Math.floor(Math.random() * (window.innerHeight - imageSize));

                    if (!isOverlapping(x, y, placed)) {
                        const img = document.createElement('img');
                        img.src = src;
                        img.className = 'sprite';
                        img.style.position = 'absolute';
                        img.style.width = `${imageSize * 2}px`;
                        img.style.height = 'auto';
                        img.style.left = `${x}px`;
                        img.style.top = `${y}px`;
                        img.style.opacity = '0.5';
                        img.style.zIndex = '0';
                        img.style.pointerEvents = 'none';

                        document.body.appendChild(img);

                        placed.push({ x, y });
                        placedSuccessfully = true;
                    }
                    tries++;
                }
            });
        }

        placeImages();
    });
    /*]]>*/
</script>

</body>
</html>
