<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>ğ“¦ğ“¸ğ“¸ğ“»ğ“²</title>
    <link rel="stylesheet" th:href="@{'/style/skin/default/common/filestorage/filestorage.css'}">
</head>
<body>
<div layout:fragment="content" class="aiview">

    <style>
        body {display: block}
        /* jsTree ê¸°ë³¸ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸° */
        .jstree-themeicon { background: none !important; }

        /* í´ë” */
        .jstree-icon.folder-emoji::before { content: "ğŸ“"; display: inline-block; width: 1em; text-align: center; }
        /* ì¼ë°˜ íŒŒì¼ */
        .jstree-icon.file-emoji::before { content: "ğŸ“„"; display: inline-block; width: 1em; text-align: center; }
        /* ì´ë¯¸ì§€ */
        .jstree-icon.image-emoji::before { content: "ğŸ–¼ï¸"; display: inline-block; width: 1em; text-align: center; }
        /* PDF */
        .jstree-icon.pdf-emoji::before { content: "ğŸ“•"; display: inline-block; width: 1em; text-align: center; }
        /* DOC/DOCX */
        .jstree-icon.doc-emoji::before { content: "ğŸ“„"; display: inline-block; width: 1em; text-align: center; }
        /* ì—‘ì…€ */
        .jstree-icon.xls-emoji::before { content: "ğŸ“Š"; display: inline-block; width: 1em; text-align: center; }
        /* ì˜ìƒ */
        .jstree-icon.video-emoji::before { content: "ğŸ¬"; display: inline-block; width: 1em; text-align: center; }
        /* ì˜¤ë””ì˜¤ */
        .jstree-icon.audio-emoji::before { content: "ğŸµ"; display: inline-block; width: 1em; text-align: center; }

    </style>


    <div class="content-wrapper" style="padding: 2% 5%;">
        <h1 class="page-title-center">File Storage</h1>

        <div class="filestorage-topbar">
            <div class="filestorage-actions">
                <button id="refresh-btn" class="filestorage-btn">ìƒˆë¡œê³ ì¹¨</button>
                <button id="upload-btn" class="filestorage-btn">íŒŒì¼ ì—…ë¡œë“œ</button>
                <button id="create-root-folder-btn" class="filestorage-btn">í´ë” ìƒì„±</button>

                <input type="file" id="file-input" multiple class="filestorage-file-input-hidden">
            </div>
        </div>

        <div class="filestorage-tree-container">
            <div class="filestorage-search-section">
                <div class="filestorage-search">
                    <input type="text" id="filestorage-search" placeholder="íŒŒì¼ ê²€ìƒ‰...">
                </div>
            </div>
            <div id="filestorage-tree"></div>
        </div>

        <div id="filestorage-context-menu" class="filestorage-context-menu">
            <div class="filestorage-context-menu-item" data-action="download">ë‹¤ìš´ë¡œë“œ</div>
            <div class="filestorage-context-menu-item" data-action="delete">ì‚­ì œ</div>
        </div>

        <!-- ì—…ë¡œë“œ í™•ì¸ ëª¨ë‹¬ -->
        <div id="upload-confirm-modal" class="filestorage-modal">
            <div class="filestorage-modal-content">
                <div class="filestorage-modal-header">
                    <h3>íŒŒì¼ ì—…ë¡œë“œ í™•ì¸</h3>
                </div>
                <div class="filestorage-modal-body">
                    <p>ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    <div id="selected-files-list" class="filestorage-selected-files"></div>
                </div><br>
                <div class="filestorage-modal-footer">
                    <button id="confirm-upload-btn" class="filestorage-btn">ì—…ë¡œë“œ</button>
                    <button id="cancel-upload-btn" class="filestorage-btn filestorage-btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <!-- ì—…ë¡œë“œ ì§„í–‰ ëª¨ë‹¬ -->
        <div id="upload-progress-modal" class="filestorage-modal">
            <div class="filestorage-modal-content">
                <div class="filestorage-modal-header">
                    <h3>íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</h3>
                </div><br>
                <div class="filestorage-modal-body">
                    <!-- GIF ë¨¼ì € -->
                    <div class="upload-loading-gif" id="upload-loading-gif">
                        <img src="/loading/business(white).gif" alt="loading...">
                    </div><br>
                    <!-- í¼ì„¼íŠ¸ë°” -->
                    <div class="filestorage-progress-container">
                        <!-- íŒŒì¼ëª… í‘œì‹œ -->
                        <div id="upload-file-info" class="filestorage-upload-file-info"></div>

                        <div class="filestorage-progress-bar">
                            <div id="upload-progress" class="filestorage-progress-fill"></div>
                        </div>
                        <div id="upload-progress-text" class="filestorage-progress-text">0%</div>
                    </div>

                    <div id="upload-status" class="filestorage-upload-status">ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...</div><br>
                    <button id="abort-upload-btn" class="filestorage-btn filestorage-btn-secondary" style="text-align: center">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script>
        let filestorageTree;
        let currentPath = "/";
        let selectedFiles = [];
        let currentUploadXhr = null; // ì—…ë¡œë“œ ì¶”ì ìš© XHR

        function initFileStorageTree() {
            filestorageTree = $('#filestorage-tree').jstree({
                'core': {
                    'data': {
                        'url': '/filestorage/filelist',
                        'data': function (node) {
                            return { 'path': node.id === '#' ? '/' : node.id };
                        }
                    },
                    'check_callback': true
                },
                'plugins': ['dnd', 'contextmenu', 'search', 'types'],
                'dnd': { 'is_draggable': () => true },
                'contextmenu': {
                    'items': function(node) {
                        const items = {};
                        if (node.type === "default") {
                            items.createFolder = { label: 'ìƒˆ í´ë”', action: () => createFolder(node.id) };
                            items.rename = { label: 'ì´ë¦„ ë³€ê²½', action: () => renameItem(node.id, true) };
                            items.upload = {
                                label: 'ì—…ë¡œë“œ',
                                action: () => {
                                    currentPath = node.id;
                                    $('#file-input').click();
                                }
                            };
                            items.delete = { label: 'ì‚­ì œ', action: () => deleteItem(node.id, true) };

                        } else {
                            items.download = { label: 'ë‹¤ìš´ë¡œë“œ', action: () => downloadFile(node.id) };
                            items.rename = { label: 'ì´ë¦„ ë³€ê²½', action: () => renameItem(node.id, false) };
                            items.delete = { label: 'ì‚­ì œ', action: () => deleteItem(node.id, false) };
                        }
                        return items;
                    }
                },
                'types': {
                    'default': { 'icon': 'folder-emoji' },
                    'file': { 'icon': 'file-emoji' },
                    'image': { 'icon': 'image-emoji' },
                    'pdf': { 'icon': 'pdf-emoji' },
                    'doc': { 'icon': 'doc-emoji' },
                    'xls': { 'icon': 'xls-emoji' },
                    'video': { 'icon': 'video-emoji' },
                    'audio': { 'icon': 'audio-emoji' },
                },
                'search': { 'case_insensitive': true, 'show_only_matches': true }
            });
            setupTreeEvents();
            setupButtonEvents();
            hideLockedFolders();
        }

        function setupTreeEvents() {
            $('#filestorage-tree')
                .on('select_node.jstree', function (e, data) {
                    const node = data.node;
                    currentPath = node.id;
                    if (node.original && node.original.directory && (!node.children || node.children.length === 0)) {
                        $('#filestorage-tree').jstree('load_node', node);
                    }
                })
                .on('move_node.jstree', function (e, data) {
                    const from = (data.node.id === '#') ? '/' : data.node.id;
                    const to = (data.parent === '#') ? '/' : data.parent;

                    fetch("/filestorage/move", {
                        method: "POST",
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({from: from, to: to})
                    }).then(() => $('#filestorage-tree').jstree('refresh'));
                });
        }


        function setupButtonEvents() {
            $('#refresh-btn').click(() => filestorageTree.jstree('refresh'));
            $('#upload-btn').click(() => $('#file-input').click());
            $('#file-input').change(e => {
                const files = e.target.files;
                if (files.length > 0) { selectedFiles = Array.from(files); showUploadConfirmModal(); }
            });

            $('#upload-modal-close, #cancel-upload-btn').click(() => {
                $('#upload-confirm-modal').hide();
                $('#file-input').val(''); selectedFiles = [];
            });

            $('#confirm-upload-btn').click(() => uploadFiles(selectedFiles));

            $('#abort-upload-btn').click(() => {
                if (currentUploadXhr) {
                    currentUploadXhr.abort();
                    $('#upload-status').text('ì—…ë¡œë“œ ì·¨ì†Œë¨');
                    $('#upload-progress').css('width','0%');
                    $('#upload-loading-gif').hide();
                    currentUploadXhr = null;
                    setTimeout(() => { $('#upload-progress-modal').hide(); }, 800);
                }
            });

            $(document).click(e => {
                const modal = document.getElementById('upload-confirm-modal');
                if (e.target === modal) { modal.style.display = 'none'; $('#file-input').val(''); selectedFiles = []; }
            });

            $('.filestorage-context-menu-item').click(function() {
                const action = $(this).data('action');
                const selectedNode = filestorageTree.jstree('get_selected')[0];
                if (!selectedNode) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                const node = filestorageTree.jstree('get_node', selectedNode);
                if (action === 'download') downloadFile(node.id);
                else if (action === 'delete') deleteItem(node.id, node.original.directory);
                $('#filestorage-context-menu').hide();
            });
        }

        function showUploadConfirmModal() {
            const filesList = document.getElementById('selected-files-list');
            filesList.innerHTML = '';
            selectedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'filestorage-file-item';
                fileItem.innerHTML = `<span class="filestorage-file-name">${file.name}</span>
                                <span class="filestorage-file-size">${formatFileSize(file.size)}</span>`;
                filesList.appendChild(fileItem);
            });
            $('#upload-confirm-modal').show();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes','KB','MB','GB'], i = Math.floor(Math.log(bytes)/Math.log(k));
            return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i];
        }

        function uploadFiles(files) {
            $('#upload-confirm-modal').hide();
            $('#upload-progress-modal').show();
            $('#upload-status').text('ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...');
            $('#upload-progress').css('width','0%');
            $('#upload-loading-gif').show();

            // âœ… íŒŒì¼ëª… + í¬ê¸° í‘œì‹œ
            if (files.length > 0) {
                const f = files[0];
                $('#upload-file-info').text(`${f.name} (${formatFileSize(f.size)})`);
            }

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('path', currentPath);

            const xhr = new XMLHttpRequest();
            currentUploadXhr = xhr;

            xhr.upload.addEventListener('progress', e => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    $('#upload-progress').css('width', percentComplete+'%');
                    $('#upload-progress-text').text(Math.round(percentComplete)+'%');
                    $('#upload-status').text(`ì—…ë¡œë“œ ì¤‘...`);
                }
            });
            xhr.addEventListener('load', () => {
                currentUploadXhr = null; //
                if (xhr.status===200) {
                    $('#upload-progress').css('width','100%'); $('#upload-status').text('ì—…ë¡œë“œ ì™„ë£Œ!');
                    $('#upload-loading-gif').hide();
                    setTimeout(() => { $('#upload-progress-modal').hide(); filestorageTree.jstree('refresh'); alert('ì—…ë¡œë“œ ì™„ë£Œ'); }, 800);
                } else {
                    $('#upload-status').text('ì—…ë¡œë“œ ì‹¤íŒ¨');
                    $('#upload-loading-gif').hide();
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            });
            xhr.open('POST','/filestorage/upload');
            xhr.send(formData);
        }

        function downloadFile(path) { window.location.href = `/filestorage/download?path=${encodeURIComponent(path)}`; }
        function deleteItem(path, isDir) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!password) return;
            fetch('/filestorage/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path, directory: isDir, password: password })
            })
                .then(async res => {
                    const text = await res.text();
                    if (res.ok) {
                        filestorageTree.jstree('refresh');
                        // íŒŒì¼ ì‚­ì œ í›„ ì—…ë¡œë“œ ì´ˆê¸°í™”
                        $('#file-input').val('');
                        selectedFiles = [];
                        alert(text || 'ì‚­ì œ ì™„ë£Œ');
                    }
                    else { alert(text || 'ì‚­ì œ ì‹¤íŒ¨'); }
                })
                .catch(err => alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message));
        }


        function createFolder(parentPath) {
            const folderName = prompt("ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!folderName) return;

            fetch('/filestorage/create-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: folderName, path: parentPath }) // ë¶€ëª¨ í´ë” ê²½ë¡œ ì‚¬ìš©
            })
                .then(async res => {
                    if (res.ok) {
                        alert("í´ë” ìƒì„± ì™„ë£Œ");
                        filestorageTree.jstree('refresh', parentPath); // ë¶€ëª¨ í´ë”ë§Œ ìƒˆë¡œê³ ì¹¨
                    } else {
                        const text = await res.text();
                        alert(text || "í´ë” ìƒì„± ì‹¤íŒ¨");
                    }
                })
                .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
        }

        function renameItem(path, isDir) {
            const currentName = path.split('/').pop();
            const newName = prompt(`${isDir ? 'í´ë”' : 'íŒŒì¼'} ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, currentName);
            if (!newName || newName === currentName) return;

            const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!password) return;

            fetch('/filestorage/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path, newName: newName, directory: isDir, password: password })
            })
                .then(async res => {
                    const text = await res.text();
                    if (res.ok) {
                        alert("ì´ë¦„ ë³€ê²½ ì™„ë£Œ");
                        filestorageTree.jstree('refresh');
                    } else {
                        alert(text || "ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨");
                    }
                })
                .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
        }




        function deleteItem(path, isDir) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:'); // í•„ìš”ì‹œ
            if (!password) return;

            fetch('/filestorage/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path, directory: isDir, password: password })
            })
                .then(async res => {
                    const text = await res.text();
                    if (res.ok) {
                        filestorageTree.jstree('refresh');
                        alert(text || 'ì‚­ì œ ì™„ë£Œ');
                    } else {
                        alert(text || 'ì‚­ì œ ì‹¤íŒ¨');
                    }
                })
                .catch(err => alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message));
        }

        const hiddenFolders = ["ë³´ì•ˆìë£Œ", "ì‹œí—˜ìë£Œ", "WebServer", "PCì¬ì›", "í”„ë¡œê·¸ë¨"];
        let unlockedFolders = [];

        // íŠ¸ë¦¬ ë¡œë“œ/ê°±ì‹  ì‹œ ìˆ¨ê¹€ ì ìš©
        function hideLockedFolders() {
            const tree = $('#filestorage-tree').jstree(true);
            if (!tree) return;
            try {
                tree.get_json('#', { flat: true })
                    .filter(node => hiddenFolders.includes(node.text) && !unlockedFolders.includes(node.text))
                    .forEach(node => tree.hide_node(node.id));
            } catch (e) {
            }
        }


        function revealAllHiddenFolders() {
            const tree = $('#filestorage-tree').jstree(true);
            if (!tree) return;
            hiddenFolders.forEach(name => {
                if (!unlockedFolders.includes(name)) unlockedFolders.push(name);
            });
            try {
                tree.get_json('#', { flat: true })
                    .filter(node => hiddenFolders.includes(node.text))
                    .forEach(node => tree.show_node(node.id));
            } catch (e) {}
        }

        $(document).ready(function() {
            initFileStorageTree();
            $('#filestorage-search').on('keyup', function(){ filestorageTree.jstree('search', $(this).val()); });

            $('#filestorage-tree').on('ready.jstree refresh.jstree load_node.jstree', function() {
                hideLockedFolders();
            });

            setTimeout(hideLockedFolders, 500);
        });

        //ë¹„ë²ˆê²€ì¦
        (function() {
            const sequence = [
                'ArrowUp','ArrowUp','ArrowUp',
                'ArrowDown','ArrowDown','ArrowDown',
                // ìœ„ 7ë²ˆ:
                'ArrowUp','ArrowUp','ArrowUp','ArrowUp','ArrowUp','ArrowUp','ArrowUp'
            ];
            let buffer = [];

            document.addEventListener('keydown', function(e) {
                const key = e.key;
                buffer.push(key);
                if (buffer.length > sequence.length) buffer.shift();
                if (JSON.stringify(buffer) === JSON.stringify(sequence)) {
                    buffer = [];
                    triggerSecretPasswordPrompt();
                }
            });

            function triggerSecretPasswordPrompt() {
                const password = prompt("ì ‘ê·¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (password === null) return; // ì·¨ì†Œ

                // ì„œë²„ì— ê²€ì¦ì„ ìš”ì²­í•©ë‹ˆë‹¤.
                fetch('/filestorage/secret-access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                })
                    .then(async res => {
                        if (res.ok) {
                            // ì„œë²„ ê²€ì¦ ì„±ê³µ â†’ ìˆ¨ê¹€ í´ë” í‘œì‹œ
                            revealAllHiddenFolders();
                            alert("ì ‘ê·¼ í—ˆìš© â€” ìˆ¨ê¹€ í´ë”ê°€ í‘œì‹œë©ë‹ˆë‹¤.");
                        } else {
                            const text = await res.text();
                            alert(text || "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        }
                    })
                    .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
            }
        })();

        $('#create-root-folder-btn').click(() => createFolder("/"));

    </script>
</div>
</body>
</html>
