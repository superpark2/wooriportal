<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùì¶ùì∏ùì∏ùìªùì≤</title>
    <link rel="stylesheet" href="/style/skin/default/common/pcinforequire.css">
</head>
<body class="pcinfo-view">

<div layout:fragment="content" class="pcinfo-container">
    <div class="container pcinfo-view">
        <div class="pcinfo-header">
            <h1 class="pcinfo-title">PC ÏöîÏ≤≠ Î™©Î°ù</h1>
            <div class="header-controls">
                <a class="btn btn-secondary btn-sm" th:href="@{'/pcinforequire'(status='ÎØ∏ÏôÑÎ£å',size=${size})}">ÎØ∏ÏôÑÎ£åÎßå Î≥¥Í∏∞</a>
                <a class="btn btn-secondary btn-sm" th:href="@{'/pcinforequire'(size=${size})}">Ï†ÑÏ≤¥Î≥¥Í∏∞</a>
            </div>
        </div>

        <div class="table-section">
            <div class="request-cards">
                <div th:each="req : ${content}" class="request-card">
                    <div class="card-header">
                        <div class="author-info">
                            <div class="req-writer">
                                <strong th:text="${req.reWriter}">ÏûëÏÑ±Ïûê</strong>
                                <span class="req-location" th:if="${req.pcInfo != null}">
                                    <span th:if="${req.pcInfo.buildingName != null and req.pcInfo.locationName != null}" 
                                          th:text="'(' + ${req.pcInfo.buildingName} + '/' + ${req.pcInfo.locationName} + '/' + ${req.reSeat} + ')'">(Í±¥Î¨º/Î£∏/Ï¢åÏÑù)</span>
                                    <span th:if="${req.pcInfo.buildingName == null and req.pcInfo.locationName != null}" 
                                          th:text="'(' + ${req.pcInfo.locationName} + '/' + ${req.reSeat} + ')'">(Î£∏/Ï¢åÏÑù)</span>
                                    <span th:if="${req.pcInfo.buildingName != null and req.pcInfo.locationName == null}" 
                                          th:text="'(' + ${req.pcInfo.buildingName} + '/' + ${req.reSeat} + ')'">(Í±¥Î¨º/Ï¢åÏÑù)</span>
                                    <span th:if="${req.pcInfo == null and req.reSeat != null}" 
                                          th:text="'(' + ${req.reSeat} + ')'">(Ï¢åÏÑù)</span>
                                </span>
                            </div>
                        </div>
                        <div class="card-date" th:text="${#temporals.format(req.createdAt,'yyyy. MM. dd')}">2025. 10. 11</div>
                    </div>
                    
                    <div class="card-content">
                        <div class="req-question" th:text="${req.reContent}">ÏßàÎ¨∏</div>
                        <!-- ÎãµÎ≥ÄÎì§ ÌëúÏãú -->
                        <div th:each="answer : ${req.answers}" th:if="${answer != null}" 
                             class="req-answer">
                            <div class="answer-content">
                                <span th:text="${answer.reWriter + ': ' + answer.reContent}">ÎãµÎ≥Ä: ...</span>
                            </div>
                            <div class="answer-actions">
                                <button class="btn btn-sm btn-danger btn-delete-answer" th:attr="data-renum=${answer.reNum}">ÏÇ≠Ï†ú</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <div class="status-section">
                            <span class="status-label">ÏÉÅÌÉú:</span>
                            <button class="btn btn-primary btn-sm btn-toggle-status" th:attr="data-renum=${req.reNum},data-status=${req.reStatus}" th:text="${req.reStatus}">ÎØ∏ÏôÑÎ£å</button>
                        </div>
                        <div class="action-section">
                            <button class="btn btn-secondary btn-sm btn-reply" th:attr="data-renum=${req.reNum}">ÎãµÎ≥Ä</button>
                            <button class="btn btn-danger btn-sm require-delete" th:attr="data-renum=${req.reNum}">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="logs-pagination" th:if="${page.totalPages>1}">
                <a class="log-page-btn-terran" th:classappend="${page.first} ? ' disabled'" th:href="@{'/pcinforequire'(page=${page.number-1},size=${size},status=${status})}" th:if="${!page.first}">&lt;</a>
                <button class="log-page-btn-terran" th:if="${page.first}" disabled>&lt;</button>
                <span class="log-page-info" th:text="${page.number+1} + ' / ' + ${page.totalPages}">1 / 1</span>
                <a class="log-page-btn-terran" th:classappend="${page.last} ? ' disabled'" th:href="@{'/pcinforequire'(page=${page.number+1},size=${size},status=${status})}" th:if="${!page.last}">&gt;</a>
                <button class="log-page-btn-terran" th:if="${page.last}" disabled>&gt;</button>
            </div>
        </div>
    </div>

    <div id="replyModal" class="pcinfo-modal">
        <div class="pcinfo-modal-content">
            <h2 class="pcinfo-modal-title">ÎãµÎ≥Ä Îì±Î°ù</h2>
            <div class="pcinfo-form-group">
                <label for="replyWriter">ÏûëÏÑ±Ïûê</label>
                <input id="replyWriter" class="pcinfo-input" type="text">
            </div>
            <div class="pcinfo-form-group">
                <label for="replyContent">ÎÇ¥Ïö©</label>
                <textarea id="replyContent" class="pcinfo-textarea" rows="5"></textarea>
            </div>
            <div class="pcinfo-modal-btns">
                <button id="replyOk" class="btn btn-primary">Îì±Î°ù</button>
                <button id="replyCancel" class="btn btn-secondary">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

</div>

<div layout:fragment="script">
    <script>
        let currentReplyTarget = null;
        document.addEventListener('DOMContentLoaded', () => { bindReqEvents(); });

        function bindReqEvents(){
            document.addEventListener('click',(e)=>{
                const t = e.target;
                if(!t || !t.classList) return;
                if(t.classList.contains('require-delete')){
                    const id = t.getAttribute('data-renum');
                    if(!id) return; if(!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                    fetch(`/pcinfo/require/${id}`,{method:'DELETE'}).then(r=>r.json()).then(res=>{ if(res.success) location.reload(); });
                }
                if(t.classList.contains('btn-reply')){
                    currentReplyTarget = t.getAttribute('data-renum');
                    document.getElementById('replyWriter').value='';
                    document.getElementById('replyContent').value='';
                    document.getElementById('replyModal').classList.add('show');
                }
                if(t.classList.contains('btn-toggle-status')){
                    const id = t.getAttribute('data-renum');
                    const currentStatus = t.getAttribute('data-status');
                    const newStatus = currentStatus === 'ÎØ∏ÏôÑÎ£å' ? 'ÏôÑÎ£å' : 'ÎØ∏ÏôÑÎ£å';
                    const confirmMsg = newStatus === 'ÏôÑÎ£å' ? 'ÏôÑÎ£å Ï≤òÎ¶¨ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?' : 'ÎØ∏ÏôÑÎ£åÎ°ú Î∞îÍæ∏Í≤†ÏäµÎãàÍπå?';
                    
                    if(!confirm(confirmMsg)) return;
                    
                    fetch(`/pcinforequire/${id}/status?status=${encodeURIComponent(newStatus)}`,{method:'POST'})
                        .then(r=>{
                            if(r.ok) {
                                t.textContent = newStatus;
                                t.setAttribute('data-status', newStatus);
                                alert(`ÏÉÅÌÉúÍ∞Ä ${newStatus}Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                            } else {
                                alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®');
                            }
                        })
                        .catch(()=>alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'));
                }

                if(t.classList.contains('btn-delete-answer')){
                    const answerNum = t.getAttribute('data-renum');
                    if(!answerNum) return;
                    if(!confirm('ÎãµÎ≥ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                    
                    fetch(`/pcinfo/require/${answerNum}`,{method:'DELETE'})
                        .then(r=>{
                            if(r.ok) {
                                alert('ÎãµÎ≥ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                                location.reload();
                            } else {
                                alert('ÎãµÎ≥Ä ÏÇ≠Ï†ú Ïã§Ìå®');
                            }
                        })
                        .catch(()=>alert('ÎãµÎ≥Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'));
                }
            });

            document.getElementById('replyCancel').addEventListener('click',()=>document.getElementById('replyModal').classList.remove('show'));
            document.getElementById('replyOk').addEventListener('click',()=>{
                const writer = document.getElementById('replyWriter').value.trim();
                const content = document.getElementById('replyContent').value.trim();
                if(!writer||!content){ alert('ÏûëÏÑ±ÏûêÏôÄ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
                fetch(`/pcinforequire/${currentReplyTarget}/reply`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({reWriter: writer, reContent: content})})
                    .then(r=>r.json()).then(res=>{ document.getElementById('replyModal').classList.remove('show'); location.reload(); });
            });
            
        }
    </script>
</div>

</body>
</html>

