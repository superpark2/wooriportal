<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>𝓦𝓸𝓸𝓻𝓲</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div layout:fragment="content">

    <link rel="stylesheet" th:href="@{'/style/skin/default/common/todolist.css'}">

    <div class="todolist-container">
        <div class="todolist-header">
            <h1 class="todolist-title">
                <i class="fas fa-tasks"></i>
                <span th:text="${title} + ' ' + ${subTitle}" class="form-title">타이틀</span>
            </h1>
            <button class="btn btn-primary" id="addTodoBtn">
                <i class="fas fa-plus"></i>
                새 할일
            </button>
        </div>

        <div class="todolist-list">
            <div th:each="todo : ${todolist.content}" class="todo-item" th:classappend="${todo.todoDone} ? 'completed' : ''">
                <div class="todo-content">
                    <div class="todo-title" th:text="${todo.todoTitle}">할일 제목</div>
                    <div class="todo-description" th:text="${todo.todoContent}">할일 내용</div>
                    <div class="todo-meta">
                        <span class="todo-date">
                            <i class="fas fa-calendar-plus"></i>
                            <span th:text="${#temporals.format(todo.createdAt, 'yyyy-MM-dd')}">등록일</span>
                        </span>
                        <span class="todo-deadline" th:if="${todo.doneDate != null}">
                            <i class="fas fa-check-circle"></i>
                            <span th:text="${#temporals.format(todo.doneDate, 'yyyy-MM-dd')}">완료일</span>
                        </span>
                    </div>
                </div>
                <div class="todo-actions">
                    <button class="btn-icon complete-btn" th:data-status="${todo.todoDone} ? 'completed' : 'pending'" th:data-todo-num="${todo.todoNum}">
                        <i class="fas" th:class="${todo.todoDone} ? 'fa-undo' : 'fa-check'"></i>
                    </button>
                    <button class="btn-icon edit-btn" th:data-todo-num="${todo.todoNum}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon delete-btn" th:data-todo-num="${todo.todoNum}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div th:if="${todolist.content.isEmpty()}" class="empty-todolist">
                <i class="fas fa-clipboard-list"></i>
                <p>등록된 할일이 없습니다.</p>
                <p>새 할일을 추가해보세요!</p>
            </div>
        </div>
    </div>

    <div class="modal" id="todoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">새 할일 등록</h2>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="todoForm">
                    <div class="form-group">
                        <label for="todoTitle">제목</label>
                        <input type="text" id="todoTitle" class="form-input" placeholder="할일 제목을 입력하세요..." maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label for="todoDescription">내용</label>
                        <textarea id="todoDescription" class="form-textarea" placeholder="상세 내용을 입력하세요..." maxlength="500" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">취소</button>
                <button type="button" class="btn btn-primary" id="saveBtn">저장</button>
            </div>
        </div>
    </div>

</div>

<div layout:fragment="script">
    <script th:inline="javascript">
        const group = /*[[${group}]]*/ '';

        const modal = document.getElementById('todoModal');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const modalTitle = document.getElementById('modalTitle');
        const todoForm = document.getElementById('todoForm');

        let isEditMode = false;
        let editingTodoNum = null;

        addTodoBtn.addEventListener('click', function() {
            isEditMode = false;
            editingTodoNum = null;
            modalTitle.textContent = '새 할일 등록';
            todoForm.reset();
            modal.style.display = 'flex';
        });

        function closeModalFunc() {
            modal.style.display = 'none';
            todoForm.reset();
            isEditMode = false;
            editingTodoNum = null;
        }

        closeModal.addEventListener('click', closeModalFunc);
        cancelBtn.addEventListener('click', closeModalFunc);

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModalFunc();
            }
        });

        document.querySelectorAll('.complete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const todoNum = this.getAttribute('data-todo-num');
                toggleTodoStatus(todoNum, this);
            });
        });

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const todoNum = this.getAttribute('data-todo-num');
                const todoItem = this.closest('.todo-item');
                const title = todoItem.querySelector('.todo-title').textContent;
                const description = todoItem.querySelector('.todo-description').textContent;

                isEditMode = true;
                editingTodoNum = todoNum;
                modalTitle.textContent = '할일 수정';

                document.getElementById('todoTitle').value = title;
                document.getElementById('todoDescription').value = description;

                modal.style.display = 'flex';
            });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('정말로 이 할일을 삭제하시겠습니까?')) {
                    const todoNum = this.getAttribute('data-todo-num');
                    deleteTodo(todoNum, this.closest('.todo-item'));
                }
            });
        });

        saveBtn.addEventListener('click', function() {
            const title = document.getElementById('todoTitle').value.trim();
            const description = document.getElementById('todoDescription').value.trim();

            if (!title || !description) {
                alert('제목과 내용을 입력해주세요.');
                return;
            }

            const todoData = {
                todoTitle: title,
                todoContent: description
            };

            if (isEditMode && editingTodoNum) {
                updateTodo(editingTodoNum, todoData);
            } else {
                addTodo(todoData);
            }
        });

        function addTodo(todoData) {
            fetch(`/${group}/todolist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(todoData)
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('할일 추가에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('할일 추가 중 오류가 발생했습니다.');
            });
        }

        function updateTodo(todoNum, todoData) {
            fetch(`/${group}/todolist/${todoNum}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(todoData)
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('할일 수정에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('할일 수정 중 오류가 발생했습니다.');
            });
        }

        function deleteTodo(todoNum, todoItem) {
            fetch(`/${group}/todolist/${todoNum}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    todoItem.remove();
                } else {
                    alert('할일 삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('할일 삭제 중 오류가 발생했습니다.');
            });
        }

        function toggleTodoStatus(todoNum, button) {
            console.log('상태 변경 요청:', todoNum);
            fetch(`/${group}/todolist/${todoNum}/toggle`, {
                method: 'PATCH'
            })
            .then(response => {
                console.log('응답 상태:', response.status, response.statusText);
                if (response.ok) {
                    console.log('상태 변경 성공');
                    location.reload();
                } else {
                    console.error('상태 변경 실패:', response.status);
                    alert('상태 변경에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('상태 변경 중 오류가 발생했습니다.');
            });
        }
    </script>
</div>

</body>
</html>
