<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>ğ“¦ğ“¸ğ“¸ğ“»ğ“²</title>
    <link rel="stylesheet" href="/style/skin/default/common/utilities/weather.css">
</head>
<body>
<div layout:fragment="content">
<h1>ğŸ“… ë„ì‹œë³„ 3ì¼ì¹˜ ë‚ ì”¨ ì˜ˆë³´</h1>

<label for="city-select">ë„ì‹œ ì„ íƒ:</label>
<select id="city-select">
    <option value="seoul">ì„œìš¸</option>
    <option value="incheon">ì¸ì²œ</option>
    <option value="busan">ë¶€ì‚°</option>
    <option value="daegu">ëŒ€êµ¬</option>
    <option value="gwangju">ê´‘ì£¼</option>
    <option value="daejeon">ëŒ€ì „</option>
    <option value="ulsan">ìš¸ì‚°</option>
    <option value="suwon">ìˆ˜ì›</option>
    <option value="cheongju">ì²­ì£¼</option>
    <option value="jeonju">ì „ì£¼</option>
    <option value="chuncheon">ì¶˜ì²œ</option>
    <option value="gangneung">ê°•ë¦‰</option>
    <option value="jeju">ì œì£¼</option>
</select>

<div id="main-card">í˜„ì¬ ê¸°ì˜¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
<div id="forecast-container">ì˜ˆë³´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<div id="status"></div>
</div>

<div layout:fragment="script">
<script>

    const select = document.getElementById('city-select');
    // NOTE: 'renderDone' ë³€ìˆ˜ëŠ” ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    const mainCard = document.getElementById('main-card');
    const container = document.getElementById('forecast-container');


    const cityCoords = {
        seoul: { name: 'ì„œìš¸', nx: 60, ny: 127 },
        incheon: { name: 'ì¸ì²œ', nx: 55, ny: 124 },
        busan: { name: 'ë¶€ì‚°', nx: 98, ny: 76 },
        daegu: { name: 'ëŒ€êµ¬', nx: 89, ny: 90 },
        gwangju: { name: 'ê´‘ì£¼', nx: 58, ny: 74 },
        daejeon: { name: 'ëŒ€ì „', nx: 67, ny: 100 },
        ulsan: { name: 'ìš¸ì‚°', nx: 102, ny: 84 },
        suwon: { name: 'ìˆ˜ì›', nx: 60, ny: 121 },
        cheongju: { name: 'ì²­ì£¼', nx: 69, ny: 106 },
        jeonju: { name: 'ì „ì£¼', nx: 63, ny: 89 },
        chuncheon: { name: 'ì¶˜ì²œ', nx: 73, ny: 134 },
        gangneung: { name: 'ê°•ë¦‰', nx: 92, ny: 131 },
        jeju: { name: 'ì œì£¼', nx: 52, ny: 38 }
    };

    const categoryMap = {
        TMP: 'ê¸°ì˜¨(â„ƒ)',
        POP: 'ê°•ìˆ˜í™•ë¥ (%)',
        SKY: 'í•˜ëŠ˜ìƒíƒœ',
        PTY: 'ê°•ìˆ˜í˜•íƒœ'
    };

    const skyMap = { '1': 'ë§‘ìŒ', '3': 'êµ¬ë¦„ ë§ìŒ', '4': 'íë¦¼' };
    const ptyMap = { '0': 'ì—†ìŒ', '1': 'ë¹„', '2': 'ë¹„/ëˆˆ', '3': 'ëˆˆ', '4': 'ì†Œë‚˜ê¸°' };


    const skyImgMap = {
        '1': 'weather/background/GOOD.png',     // ë§‘ìŒ
        '3': 'weather/background/HELL.png',    // êµ¬ë¦„ ë§ìŒ
        '4': 'weather/background/BAD.png'   // íë¦¼
    };

    const nightSkyImg = 'weather/background/NIGHT.png';

    const ptyImgMap = {
        '0': 'weather/SUN.png',      // ì—†ìŒ
        '1': 'weather/RAIN.png',      // ë¹„
        '2': 'weather/RAINSNOW.png', // ë¹„/ëˆˆ
        '3': 'weather/SNOW.png',      // ëˆˆ
        '4': 'weather/RAIN.png'     // ì†Œë‚˜ê¸°
    };

    select.addEventListener('change', () => {
        const selected = select.value;
        const { nx, ny, name } = cityCoords[selected];
        fetchForecast(nx, ny, name);
    });

    function getBaseTime() {
        const now = new Date();
        const hour = now.getHours();
        const baseHours = [2, 5, 8, 11, 14, 17, 20, 23];
        let selected = baseHours[0];
        for (let i = 0; i < baseHours.length; i++) {
            if (hour >= baseHours[i]) selected = baseHours[i];
        }
        return String(selected).padStart(2, '0') + '00';
    }

    function fetchForecast(nx, ny, cityName) {
        mainCard.innerHTML = 'í˜„ì¬ ê¸°ì˜¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        container.innerHTML = 'ì˜ˆë³´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const base_date = `${yyyy}${mm}${dd}`;
        const base_time = getBaseTime();

        const serviceKey = 'wje5hA%2Bnn3R5RgOMpkRjQoneVn2py4RGqQmFJCCZS2IjYEetSvm7HP%2FngICVZN7%2FB0Mj2ig7Xp2oep7%2B4kcrSQ%3D%3D';
        const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?` +
            `serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON` +
            `&base_date=${base_date}&base_time=${base_time}&nx=${nx}&ny=${ny}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                const items = data.response.body.items.item;
                const grouped = {};

                items.forEach(item => {
                    const date = item.fcstDate;
                    const time = item.fcstTime;
                    const key = `${date}-${time}`;
                    if (!grouped[key]) grouped[key] = { date, time, data: {} };
                    grouped[key].data[item.category] = item.fcstValue;
                });

                const sorted = Object.values(grouped).sort((a, b) => a.date + a.time > b.date + b.time ? 1 : -1);

                const nowStr = `${String(now.getHours()).padStart(2, '0')}00`;
                const today = `${yyyy}${mm}${dd}`;
                const current = sorted.find(f => f.date === today && f.time >= nowStr) || sorted[0];

                const currentData = current.data;
                const currentTime = `${current.time.slice(0, 2)}ì‹œ`;
                const currentHour = parseInt(current.time.slice(0, 2));

                let currentSkyImg;
                if (currentData.SKY === '1' && (currentHour >= 20 || currentHour < 5)) {
                    currentSkyImg = nightSkyImg;
                } else {
                    currentSkyImg = skyImgMap[currentData.SKY] || 'images/default.png';
                }

                let currentPtyImg = ptyImgMap[currentData.PTY] || 'images/default.png';

                if ((currentHour >= 20 || currentHour < 5) && currentData.PTY === '0') {
                    currentPtyImg = 'weather/MOON.png';
                }

                mainCard.innerHTML = `
                                      <div class="main-card">
                                        <h2>${cityName} í˜„ì¬ (${currentTime}) ê¸°ì¤€</h2>
                                        <div>
                                        <div class="value">${currentData.TMP}â„ƒ</div>
                                <div style="width:245px; height:137px; position: relative;">
                                    <img src="${currentSkyImg}" style="width:245px;height:137px;object-fit:cover;">
                                    <img src="${currentPtyImg}" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 70%; max-height: 70%;z-index: 9999;
                                    object-fit: contain">
                                </div>
                                        <div>ê°•ìˆ˜í™•ë¥ : ${currentData.POP}%</div>
                                      </div>
                                      </div>
                                    `;

                container.innerHTML = '';
                let currentDate = '';
                let rowDiv = null;

                sorted.forEach(entry => {
                    if (entry.date !== currentDate) {
                        currentDate = entry.date;
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'forecast-day';

                        const dayTemps = sorted
                            .filter(e => e.date === currentDate)
                            .map(e => parseFloat(e.data.TMP));
                        const maxTemp = Math.max(...dayTemps);
                        const minTemp = Math.min(...dayTemps);

                        dayDiv.innerHTML = `<h3>${entry.date.slice(0,4)}-${entry.date.slice(4,6)}-${entry.date.slice(6,8)} (ìµœê³  ${maxTemp}â„ƒ / ìµœì € ${minTemp}â„ƒ)</h3>`;

                        rowDiv = document.createElement('div');
                        rowDiv.className = 'forecast-row';
                        dayDiv.appendChild(rowDiv);
                        container.appendChild(dayDiv);
                    }

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'forecast-item';

                    const time = `${entry.time.slice(0,2)}ì‹œ`;
                    const data = entry.data;

                    const ptyImg = ptyImgMap[data.PTY] || 'images/default.png';

                    itemDiv.innerHTML = `
                        <div class="pty-icon" style="text-align:center;  margin-bottom:5px; width:100%; height:60px;">
                            <img src="${ptyImg}" style="max-width:100%; max-height:100%; object-fit: contain">
                        </div>
                        <div class="time">${time}</div>
                        <div class="desc">
                            <div>ê¸°ì˜¨: ${data.TMP}â„ƒ</div>
                            <div>ê°•ìˆ˜í™•ë¥ : ${data.POP}%</div>
                            <div>í•˜ëŠ˜ìƒíƒœ: ${skyMap[data.SKY] || data.SKY}</div>
                        </div>
                    `;
                    rowDiv.appendChild(itemDiv);


                    let desc = '';
                    for (const cat of ['TMP', 'POP', 'SKY', 'PTY']) {
                        if (data[cat]) {
                            if (cat === 'PTY') {
                                const ptyImg = ptyImgMap[data.PTY] || 'images/default.png';
                                desc += `<div>${categoryMap[cat]}: <img src="${ptyImg}" style="width:24px;height:24px;vertical-align:middle;"></div>`;
                            } else {
                                let val = data[cat];
                                if (cat === 'SKY') val = skyMap[val] || val;
                                desc += `<div>${categoryMap[cat]}: ${val}</div>`;
                            }
                        }
                    }

                });
            })
            .catch(err => {
                mainCard.innerHTML = 'í˜„ì¬ ê¸°ì˜¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                container.innerHTML = 'ì˜ˆë³´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            });
    }

    (async function () {
        try {
            const res = await fetch("https://ipapi.co/json/");
            const ipData = await res.json();

            let matchedKey = null;

            for (const key in cityCoords) {
                if (key.toLowerCase() === ipData.region.toLowerCase()) {
                    matchedKey = key;
                    break;
                }
            }

            if (matchedKey) {
                const { nx, ny, name } = cityCoords[matchedKey];
                document.getElementById("city-select").value = matchedKey;
                fetchForecast(nx, ny, name);
            } else {
                document.getElementById("city-select").value = "incheon";
                const { nx, ny, name } = cityCoords["incheon"];
                fetchForecast(nx, ny, name);
            }
        } catch (e) {
            document.getElementById("city-select").value = "incheon";
            const { nx, ny, name } = cityCoords["incheon"];
            fetchForecast(nx, ny, name);
        }
    })();


</script>
</div>

</body>
</html>