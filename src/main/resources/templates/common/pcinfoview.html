<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğ“¦ğ“¸ğ“¸ğ“»ğ“²</title>
    <link rel="stylesheet" href="/style/skin/default/layout/color.css">
    <link rel="stylesheet" href="/style/skin/default/common/pcinfoview.css">
</head>
<body class="pcinfo-view aiview">
<div class="container pcinfo-view" th:attr="data-building-num=${buildingNum},data-room-num=${pc.locationNum}" th:with="pcNum=${pc.pcInfoNum}">
    <div class="header pcinfo-view">
        <h1>PC Detail</h1>
    </div>

    <div class="error-message" th:if="${error != null}" style="background: #ff6b6b; color: white; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0;">
        <h2 th:text="${error}">PC ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h2>
    </div>

    <div class="pc-image" th:if="${pc != null && pc.pcInfoImageMeta != null && !#strings.isEmpty(pc.pcInfoImageMeta)}">
        <img th:src="${pc.pcInfoImageMeta}" alt="PC ì´ë¯¸ì§€" />
    </div>

    <div class="info-section" th:if="${pc != null}">
        <div class="info-item">
            <span class="info-label">ì§€ì :</span>
            <span class="info-value" th:text="${pc.buildingName}">ê±´ë¬¼</span>
        </div>
        <div class="info-item">
            <span class="info-label">ì¥ì†Œ:</span>
            <span class="info-value" th:text="${pc.locationName}">ìœ„ì¹˜</span>
        </div>
        <div class="info-item">
            <span class="info-label">ì¢Œì„ë²ˆí˜¸:</span>
            <span class="info-value" th:text="${pc.pcInfoSeatNum}">ì¢Œì„ë²ˆí˜¸</span>
        </div>
        <div class="info-item">
            <span class="info-label">CPU:</span>
            <span class="info-value" th:text="${pc.pcInfoCpu}">CPU</span>
        </div>
        <div class="info-item">
            <span class="info-label">ì €ì¥ì¥ì¹˜:</span>
            <span class="info-value" th:text="${pc.pcInfoStorage}">ì €ì¥ì¥ì¹˜</span>
        </div>
        <div class="info-item">
            <span class="info-label">RAM:</span>
            <span class="info-value" th:text="${pc.pcInfoRam}">RAM</span>
        </div>
        <div class="info-item">
            <span class="info-label">VGA:</span>
            <span class="info-value" th:text="${pc.pcInfoVga}">VGA</span>
        </div>
        <div class="info-item">
            <span class="info-label">ëª¨ë‹ˆí„°:</span>
            <span class="info-value" th:text="${pc.pcInfoMonitor}">ëª¨ë‹ˆí„°</span>
        </div>
        <div class="info-item">
            <span class="info-label">IP:</span>
            <span class="info-value" th:text="${pc.pcInfoIp}">IP</span>
        </div>
    </div>

    <div class="logs-section">
        <h2>Log</h2>
        <div id="logsContainer">
            <div class="no-logs">ë¡œë”© ì¤‘...</div>
        </div>
        <div class="logs-pagination"></div>
    </div>

    <div class="require-section">
        <h2>ìš”ì²­</h2>
        <div id="requireContainer">
            <div class="no-requires">ë¡œë”© ì¤‘...</div>
        </div>
        <div class="require-pagination" id="requirePagination">
            <button class="require-page-btn" onclick="changeRequirePage(-1)" id="reqPrevPage">ì´ì „</button>
            <span class="require-page-info" id="reqPageInfo">1 / 1</span>
            <button class="require-page-btn" onclick="changeRequirePage(1)" id="reqNextPage">ë‹¤ìŒ</button>
        </div>
    </div>

</div>
<div class="pcinfo-center-margin">
    <button id="editBtn" class="pcinfo-btn-primary">ìˆ˜ì •</button>
    <button id="addLogBtn" class="pcinfo-btn-secondary">ìƒˆ ê¸°ë¡</button>
    <button id="addRequireBtn" class="pcinfo-btn-secondary">ìš”ì²­</button>
    <input type="hidden" id="pcNumHidden" th:value="${pc.pcInfoNum}">
</div>


<div id="passwordModal" class="pcinfo-modal">
    <div class="pcinfo-modal-content">
        <h2 class="pcinfo-modal-title">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
        <div class="pcinfo-form-group">
            <label for="passwordInput"></label>
            <input type="password" id="passwordInput" class="pcinfo-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        </div>
        <div class="pcinfo-modal-btns">
            <button id="passwordModalOk" class="pcinfo-btn-primary">í™•ì¸</button>
            <button id="passwordModalCancel" class="pcinfo-btn-secondary">ì·¨ì†Œ</button>
        </div>
        <div id="passwordModalError" class="pcinfo-error-message">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>
</div>

<div id="editModal" class="pcinfo-modal">
    <div class="pcinfo-modal-content">
        <h2 class="pcinfo-modal-title">PC ì •ë³´ ìˆ˜ì •</h2>
        <form id="editForm">
            <input type="hidden" name="pcInfoNum" th:value="${pc.pcInfoNum}" />
            <div class="pcinfo-form-group">
                <label for="editImage">PC ì‚¬ì§„</label>
                <div class="pcinfo-file-input-wrapper">
                    <input type="file" name="pcInfoImage" id="editImage" class="pcinfo-file-input">
                    <label for="editImage" class="pcinfo-file-label">íŒŒì¼ ì„ íƒ</label>
                </div>
                <div id="editImagePreviewWrap" class="pcinfo-image-preview-wrap-edit">
                    <img id="editImagePreview"
                         th:src="${pc.pcInfoImageMeta}"
                         alt="ê¸°ì¡´ ì´ë¯¸ì§€"
                         class="pcinfo-image-preview-edit"
                    />
                    <span id="editImageName" class="pcinfo-image-name-edit"></span>
                </div>
                <label id="editDeleteImageLabel" class="pcinfo-delete-image-label-edit" th:style="${pc.pcInfoImageMeta != null ? 'display:inline;' : 'display:none;'}">
                    <input type="checkbox" name="imageDelete" id="editDeleteImageCheckbox"> ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
                </label>
            </div>
            <div class="pcinfo-form-group">
                <label for="editBuilding">ë¹Œë”©</label>
                <select id="editBuilding" class="pcinfo-input" required th:data-selected="${pc.buildingNum}"></select>
            </div>
            <div class="pcinfo-form-group">
                <label for="editRoom">ì¥ì†Œ</label>
                <select id="editRoom" class="pcinfo-input" name="locationNum" required th:data-selected="${pc.locationNum}"></select>
            </div>
            <div class="pcinfo-form-group">
                <label for="editSeatNum">ì¢Œì„ë²ˆí˜¸</label>
                <input type="text" id="editSeatNum" name="pcInfoSeatNum" class="pcinfo-input" required th:value="${pc.pcInfoSeatNum}" />
            </div>
            <div class="pcinfo-form-group">
                <label for="editCpu">CPU</label>
                <input type="text" id="editCpu" name="pcInfoCpu" class="pcinfo-input" required th:value="${pc.pcInfoCpu}" />
            </div>
            <div class="pcinfo-form-group">
                <label for="editStorage">ì €ì¥ì¥ì¹˜</label>
                <input type="text" id="editStorage" name="pcInfoStorage" class="pcinfo-input" required th:value="${pc.pcInfoStorage}" />
            </div>
            <div class="pcinfo-form-group">
                <label for="editRam">RAM</label>
                <input type="text" id="editRam" name="pcInfoRam" class="pcinfo-input" required th:value="${pc.pcInfoRam}" />
            </div>
            <div class="pcinfo-form-group">
                <label for="editVga">VGA</label>
                <input type="text" id="editVga" name="pcInfoVga" class="pcinfo-input" required th:value="${pc.pcInfoVga}" />
            </div>
            <div class="pcinfo-form-group">
                <label for="editMonitor">ëª¨ë‹ˆí„°</label>
                <input type="text" id="editMonitor" name="pcInfoMonitor" class="pcinfo-input" th:value="${pc.pcInfoMonitor}" />
            </div>
            <div class="pcinfo-form-group">
                <label for="editIp">IP</label>
                <input type="text" id="editIp" name="pcInfoIp" class="pcinfo-input" th:value="${pc.pcInfoIp}" />
            </div>
            <div class="pcinfo-modal-btns">
                <button type="submit" class="pcinfo-btn-primary">ì €ì¥</button>
                <button type="button" id="editModalCancel" class="pcinfo-btn-secondary">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<div id="logModal" class="pcinfo-modal">
    <div class="pcinfo-modal-content">
        <h2 class="pcinfo-modal-title">ìƒˆ ë¡œê·¸ ê¸°ë¡</h2>
        <div class="pcinfo-form-group">
            <label for="logContentInput">ë‚´ìš©</label>
            <textarea id="logContentInput" class="pcinfo-input" rows="4" placeholder="ë¡œê·¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="pcinfo-modal-btns">
            <button id="logModalOk" class="pcinfo-btn-primary">ì €ì¥</button>
            <button id="logModalCancel" class="pcinfo-btn-secondary">ì·¨ì†Œ</button>
        </div>
        <div id="logModalError" class="pcinfo-error-message">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
    </div>
</div>

<div id="requireModal" class="pcinfo-modal">
    <div class="pcinfo-modal-content">
        <h2 class="pcinfo-modal-title">PC ìš”ì²­ ë“±ë¡</h2>
        <form id="requireForm">
            <div class="pcinfo-form-group">
                <label for="requireAuthor">ì‘ì„±ì</label>
                <input type="text" id="requireAuthor" name="author" class="pcinfo-input" placeholder="ì‘ì„±ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>
            <div class="pcinfo-form-group">
                <label for="requireSeat">ì¢Œì„</label>
                <input type="text" id="requireSeat" name="seat" class="pcinfo-input" placeholder="ì˜ˆ: 1A-12" />
            </div>
            <div class="pcinfo-form-group">
                <label for="requireContent">ìš”ì²­ ë‚´ìš©</label>
                <textarea id="requireContent" name="content" class="pcinfo-textarea" rows="6" placeholder="ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
            </div>
            <div class="pcinfo-modal-buttons">
                <button type="submit" class="pcinfo-btn-primary">ë“±ë¡</button>
                <button type="button" id="closeRequireModal" class="pcinfo-btn-secondary">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    window.PCINFO_IMAGE_META = '[[${pc.pcInfoImageMeta}]]';
    document.addEventListener('DOMContentLoaded', function() {
        const pcNum = /*[[${pc.pcInfoNum}]]*/ 0;
        loadQrLogs(pcNum, 0);
        bindEvents();
    });

    function loadQrLogs(pcNum, page) {
        const url = `/qrlog/api/pc/${pcNum}?page=${page}&size=8`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                const logs = data.content || [];
                const container = document.getElementById('logsContainer');
                const pagination = document.querySelector('.logs-pagination');
                if (logs.length > 0) {
                    let html = '<table class="logs-table"><thead><tr><th style="width:120px">ë‚ ì§œ</th><th>ë‚´ìš©</th></tr></thead><tbody>';
                logs.forEach(log => {
                        const d = new Date(log.createdAt);
                        const date = `${d.getFullYear()}. ${(d.getMonth()+1).toString().padStart(2,'0')}. ${d.getDate().toString().padStart(2,'0')}`;
                        const text = log.content || log.logContent || '';
                        html += `<tr><td>${date}</td><td>${text}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
            } else {
                    container.innerHTML = '<div class="no-logs">ë“±ë¡ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            renderPagination(pagination, data.totalPages, data.currentPage, pcNum);
            })
            .catch(() => {
                document.getElementById('logsContainer').innerHTML = '<div class="no-logs">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        });
    }
    function renderPagination(el, totalPages, currentPage, pcNum) {
        if (!el) return;
        if (totalPages <= 1) { el.innerHTML = ''; return; }
        let html = '';
        html += currentPage > 0
            ? `<button class='log-page-btn-terran' data-page='${currentPage-1}'>&lt;</button>`
            : `<button class='log-page-btn-terran' disabled>&lt;</button>`;
        html += `<span class='log-page-info'>${currentPage+1} / ${totalPages}</span>`;
        html += currentPage < totalPages-1
            ? `<button class='log-page-btn-terran' data-page='${currentPage+1}'>&gt;</button>`
            : `<button class='log-page-btn-terran' disabled>&gt;</button>`;
        el.innerHTML = html;
        el.querySelectorAll('.log-page-btn-terran:not([disabled])').forEach(btn => {
            btn.addEventListener('click', () => {
                const page = parseInt(btn.getAttribute('data-page'));
            loadQrLogs(pcNum, page);
            });
        });
    }

    function bindEvents() {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const editModal = document.getElementById('editModal');
        const editCancel = document.getElementById('editModalCancel');
        const pcContainer = document.querySelector('.container.pcinfo-view');
        const editForm = document.getElementById('editForm');

        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordModalOk = document.getElementById('passwordModalOk');
        const passwordModalCancel = document.getElementById('passwordModalCancel');
        const passwordModalError = document.getElementById('passwordModalError');

        // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ í•¨ìˆ˜
        function verifyPassword(callback) {
            const password = passwordInput.value.trim();
            if (!password) {
                passwordModalError.style.display = 'block';
                return;
            }
            
            fetch('/facility/pcinfo/verify-password', {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: password
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    passwordModal.classList.remove('show');
                    passwordInput.value = '';
                    passwordModalError.style.display = 'none';
                    callback();
                } else {
                    passwordModalError.style.display = 'block';
                }
            })
            .catch(() => {
                passwordModalError.style.display = 'block';
            });
        }

        if (passwordModalOk) passwordModalOk.addEventListener('click', () => {
            const action = passwordModal.getAttribute('data-action');
            if (action === 'edit') {
                verifyPassword(() => {
                    const preview = document.getElementById('editImagePreview');
                    const nameEl = document.getElementById('editImageName');
                    const delLabel = document.getElementById('editDeleteImageLabel');
                    const fileName = preview?.src ? preview.src.substring(preview.src.lastIndexOf('/') + 1) : '';
                    
                    if (preview) {
                        preview.style.display = preview.src ? 'block' : 'none';
                    }
                    if (nameEl) {
                        nameEl.textContent = fileName;
                        nameEl.style.display = preview?.src ? 'inline' : 'none';
                    }
                    if (delLabel) delLabel.style.display = preview?.src ? 'inline' : 'none';

                    const buildingSelect = document.getElementById('editBuilding');
                    const roomSelect = document.getElementById('editRoom');
                    const buildingNum = buildingSelect?.getAttribute('data-selected');
                    const roomNum = roomSelect?.getAttribute('data-selected');
                    
                    loadBuildingOptions(buildingNum, roomNum);
                    editModal?.classList.add('show');
                });
            } else if (action === 'delete') {
                verifyPassword(() => {
                    const pcNum = document.getElementById('pcNumHidden')?.value;
                    if (confirm('ì •ë§ë¡œ ì´ PC ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        fetch(`/facility/pcinfo/delete?pcInfoNum=${pcNum}`, { method: 'DELETE' })
                            .then(() => {
                                alert('PC ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.href = '/facility/pcinfo/list';
                            })
                            .catch(() => alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    }
                });
            }
        });

        if (passwordModalCancel) passwordModalCancel.addEventListener('click', () => {
            passwordModal.classList.remove('show');
            passwordInput.value = '';
            passwordModalError.style.display = 'none';
        });

        if (editBtn) editBtn.addEventListener('click', () => {
            passwordModal.setAttribute('data-action', 'edit');
            passwordModal.classList.add('show');
            passwordInput.value = '';
            passwordModalError.style.display = 'none';
            passwordInput.focus();
        });

        if (deleteBtn) deleteBtn.addEventListener('click', () => {
            passwordModal.setAttribute('data-action', 'delete');
            passwordModal.classList.add('show');
            passwordInput.value = '';
            passwordModalError.style.display = 'none';
            passwordInput.focus();
        });

        if (editCancel) editCancel.addEventListener('click', () => editModal?.classList.remove('show'));

        if (editForm) editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(editForm);
            const delChk = document.getElementById('editDeleteImageCheckbox');
            if (!delChk?.checked) {
            formData.delete('imageDelete');
        } else {
            formData.set('imageDelete', 'true');
        }
            fetch('/facility/pcinfo/add', { method: 'POST', body: formData })
                .then(() => {
                alert('ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    editModal?.classList.remove('show');
                location.reload();
                })
                .catch(() => alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        });

        const addLogBtn = document.getElementById('addLogBtn');
        const logModal = document.getElementById('logModal');
        const logCancel = document.getElementById('logModalCancel');
        const logOk = document.getElementById('logModalOk');
        if (addLogBtn) addLogBtn.addEventListener('click', () => {
            logModal?.classList.add('show');
            const input = document.getElementById('logContentInput');
            const err = document.getElementById('logModalError');
            if (input) input.value = '';
            if (err) err.style.display = 'none';
        });
        if (logCancel) logCancel.addEventListener('click', () => logModal?.classList.remove('show'));
        if (logOk) logOk.addEventListener('click', () => {
            const input = document.getElementById('logContentInput');
            const content = (input?.value || '').trim();
            const err = document.getElementById('logModalError');
            if (!content) { if (err) err.style.display = 'block'; return; }
            if (err) err.style.display = 'none';
            const pcNum = document.getElementById('pcNumHidden')?.value;
            fetch(`/qrlog/api/pc/${pcNum}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) })
                .then(r => {
                    if (r.ok) {
                        alert('ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        logModal?.classList.remove('show');
                        input.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                        loadQrLogs(pcNum, 0);
                    } else {
                        alert('ë¡œê·¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(() => alert('ë¡œê·¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        });

        const addReqBtn = document.getElementById('addRequireBtn');
        const reqModal = document.getElementById('requireModal');
        const reqClose = document.getElementById('closeRequireModal');
        if (addReqBtn) addReqBtn.addEventListener('click', () => { 
            reqModal?.classList.add('show'); 
            const rf = document.getElementById('requireForm');
            if (rf && typeof (rf.reset) === 'function') { rf.reset(); }
        });
        if (reqClose) reqClose.addEventListener('click', () => reqModal?.classList.remove('show'));

        const reqForm = document.getElementById('requireForm');
        if (reqForm) reqForm.addEventListener('submit', (e) => {
            e.preventDefault();
        const pcNum = /*[[${pc.pcInfoNum}]]*/ 0;
            const body = {
                reWriter: (document.getElementById('requireAuthor') || {}).value,
                reSeat: (document.getElementById('requireSeat') || {}).value,
                reContent: (document.getElementById('requireContent') || {}).value,
                reType: 'Q',
                pcInfo: {
                    pcInfoNum: pcNum
                }
            };
            if (!body.reWriter || body.reWriter.trim() === '') { alert('ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!body.reContent || body.reContent.trim() === '') { alert('ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            fetch('/pcinfo/require/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
                .then(r => {
                    if (!r.ok) {
                        return r.text().then(text => {
                            throw new Error(text || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                    return r.json();
                })
                .then(data => {
                    alert('ìš”ì²­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    reqModal?.classList.remove('show');
                    loadRequires(0);
                })
                .catch(error => {
                    console.error('ìš”ì²­ ë“±ë¡ ì˜¤ë¥˜:', error);
                    alert('ìš”ì²­ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
                });
        });

    }

    function loadBuildingOptions(selectedBuildingNum, selectedRoomNum) {
        const url = '/location/list?type=building';
        fetch(url)
            .then(r => r.json())
            .then(buildings => {
                let options = '<option value="">ë¹Œë”©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                (buildings || []).forEach(b => {
                    const selected = String(b.locationNum) === String(selectedBuildingNum) ? 'selected' : '';
                    options += `<option value="${b.locationNum}" ${selected}>${b.locationName}</option>`;
                });
                const el = document.getElementById('editBuilding');
                if (el) el.innerHTML = options;

                if (selectedBuildingNum) {
                    loadRoomOptions(selectedBuildingNum, selectedRoomNum);
                } else {
                    const roomEl = document.getElementById('editRoom');
                    if (roomEl) roomEl.innerHTML = '<option value="">ë£¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                }
            })
            .catch(error => {
                console.error('ê±´ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const el = document.getElementById('editBuilding');
                if (el) el.innerHTML = '<option value="">ê±´ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
            });
    }
    function loadRoomOptions(buildingNum, selectedRoomNum) {
        if (!buildingNum) {
            const roomEl = document.getElementById('editRoom');
            if (roomEl) roomEl.innerHTML = '<option value="">ë£¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            return;
        }
        const url = `/location/list?type=room&buildingNum=${buildingNum}`;
        fetch(url)
            .then(r => r.json())
            .then(rooms => {
                let options = '<option value="">ë£¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                (rooms || []).forEach(rm => {
                    const selected = String(rm.locationNum) === String(selectedRoomNum) ? 'selected' : '';
                    options += `<option value="${rm.locationNum}" ${selected}>${rm.locationName}</option>`;
                });
                const el = document.getElementById('editRoom');
                if (el) el.innerHTML = options;
            })
            .catch(error => {
                console.error('ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const el = document.getElementById('editRoom');
                if (el) el.innerHTML = '<option value="">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
            });
    }
    const editBuildingEl = document.getElementById('editBuilding');
    if (editBuildingEl) editBuildingEl.addEventListener('change', (e) => {
        const target = e.target || e.srcElement;
        const val = target && target.value !== undefined ? target.value : '';
        loadRoomOptions(val, null);
    });

    var requireCurrentPage = 0;
    var requireTotalPages = 1;
    function loadRequires(page = 0) {
        const pcNum = /*[[${pc.pcInfoNum}]]*/ 0;
        requireCurrentPage = page;
        const requireContainer = document.getElementById('requireContainer');
        const paginationEl = document.getElementById('requirePagination');
        if (requireContainer) requireContainer.innerHTML = '<div class="no-requires">ë¡œë”© ì¤‘...</div>';
        fetch(`/pcinfo/require/pc/${pcNum}?page=${page}&size=5`)
            .then(r => r.json())
            .then(data => {
                if (data.content && data.content.length > 0) {
                    let html = '';
                    const questions = data.content.filter(req => req.reType === 'Q');
                    
                    console.log('Questions:', questions);
                    
                    questions.forEach(question => {
                        const ts = question.createdAt || question.created_at || question.createdDate;
                        const d = ts ? new Date(ts) : null;
                        const date = d ? `${d.getFullYear()}. ${(d.getMonth()+1).toString().padStart(2,'0')}. ${d.getDate().toString().padStart(2,'0')}` : '';
                        const author = question.reWriter || '';
                        const seat = question.reSeat || '';
                        const content = question.reContent || '';

                        const questionAnswers = question.answers || [];
                        
                        console.log('Question answers for', question.reNum, ':', questionAnswers);
                        
                        html += `
                            <div class="require-item">
                                <div class="require-header">
                                    <span class="require-author">${author}${seat ? ` (${seat})` : ''}</span>
                                    <span class="require-date">${date}</span>
                                </div>
                                <div class="require-content">${content}</div>`;

                        questionAnswers.forEach(answer => {
                            html += `
                                <div class="answer-content">
                                    ${answer.reWriter}: ${answer.reContent}
                                </div>`;
                        });
                        
                        html += `
                            </div>`;
                    });
                    if (requireContainer) requireContainer.innerHTML = html;
                    updateRequirePagination(data);
                } else {
                    if (requireContainer) requireContainer.innerHTML = '<div class="no-requires">ë“±ë¡ëœ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    if (paginationEl) paginationEl.style.display = 'none';
                }
            })
            .catch(() => {
                if (requireContainer) requireContainer.innerHTML = '<div class="no-requires">ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                if (paginationEl) paginationEl.style.display = 'none';
            });
    }
    function updateRequirePagination(data) {
        const pageInfo = document.getElementById('reqPageInfo');
        const prevBtn = document.getElementById('reqPrevPage');
        const nextBtn = document.getElementById('reqNextPage');
        const paginationEl = document.getElementById('requirePagination');
        requireTotalPages = data.totalPages || 1;
        requireCurrentPage = data.currentPage || 0;
        if (pageInfo) pageInfo.textContent = `${requireCurrentPage + 1} / ${requireTotalPages}`;
        if (prevBtn) prevBtn.disabled = requireCurrentPage === 0;
        if (nextBtn) nextBtn.disabled = requireCurrentPage === requireTotalPages - 1;
        if (paginationEl) paginationEl.style.display = requireTotalPages <= 1 ? 'none' : 'flex';
    }
    function changeRequirePage(direction) {
        const newPage = requireCurrentPage + direction;
        if (newPage >= 0 && newPage < requireTotalPages) {
            loadRequires(newPage);
        }
    }
    window.changeRequirePage = changeRequirePage;
    loadRequires(0);
</script>
</body>
</html>

