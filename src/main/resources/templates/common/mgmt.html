<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğ“¦ğ“¸ğ“¸ğ“»ğ“²</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/style/skin/default/common/mgmt.css" rel="stylesheet">
</head>
<body>
<div layout:fragment="content" class="mgmt-container">

    <div class="mgmt-header">
        <h1 class="mgmt-title">
            <i class="fas fa-users"></i>
            <span>íšŒì› ê´€ë¦¬</span>
        </h1>
    </div>

    <div class="stats-info">
        <div class="stat-card">
            <h3>ì „ì²´ íšŒì›</h3>
            <p th:text="${totalElements} + 'ëª…'">0ëª…</p>
        </div>
        <div class="stat-card">
            <h3>í˜„ì¬ í˜ì´ì§€</h3>
            <p th:text="${currentPage + 1} + ' / ' + ${totalPages}">1 / 1</p>
        </div>
    </div>

    <div class="member-table-section">
        <div class="table-header">
            <h3 class="table-title">
                <i class="fas fa-list"></i>
                íšŒì› ëª©ë¡
            </h3>
        </div>

        <table class="member-table">
            <thead>
            <tr>
                <th class="col-image">í”„ë¡œí•„</th>
                <th class="col-id">ì•„ì´ë””</th>
                <th class="col-name">ì´ë¦„</th>
                <th class="col-comment">ì†Œê°œ</th>
                <th class="col-role">ê¶Œí•œ</th>
                <th class="col-actions">ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="member : ${members}">
                <td class="col-image">
                    <img th:if="${member.memberPictureMeta}" 
                         th:src="${member.memberPictureMeta}" 
                         class="member-image" 
                         alt="í”„ë¡œí•„">
                    <i th:unless="${member.memberPictureMeta}" 
                       class="fas fa-user-circle mgmt-picture"
                       style="font-size: 40px; color: var(--text-muted);"></i>
                </td>
                <td class="col-id" th:text="${member.memberId}">user123</td>
                <td class="col-name" th:text="${member.memberName}">í™ê¸¸ë™</td>
                <td class="col-comment" th:text="${member.memberComment ?: 'â€”'}">â€”</td>
                <td class="col-role">
                    <span th:class="'role-badge role-' + ${member.memberRole}" 
                          th:text="${member.memberRole}">user</span>
                </td>
                <td class="col-actions">
                    <select class="role-select" th:data-member-num="${member.memberNum}">
                        <option value="admin" th:selected="${member.memberRole == 'admin'}">ê´€ë¦¬ì</option>
                        <option value="user" th:selected="${member.memberRole == 'user'}">ì¼ë°˜íšŒì›</option>
                        <option value="wait" th:selected="${member.memberRole == 'wait'}">ëŒ€ê¸°ì¤‘</option>
                    </select>
                    <button class="btn btn-primary btn-save" 
                            th:data-member-num="${member.memberNum}">
                        <i class="fas fa-save"></i>
                        ì €ì¥
                    </button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="pagination" th:if="${totalPages > 1}">
            <button th:if="${currentPage > 0}" 
                    th:onclick="'location.href=\'/member/mgmt?page=' + (${currentPage} - 1) + '\''">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <span th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
                <button th:if="${pageNum >= currentPage - 2 and pageNum <= currentPage + 2}"
                        th:class="${pageNum == currentPage ? 'active' : ''}"
                        th:onclick="'location.href=\'/member/mgmt?page=' + ${pageNum} + '\'"
                        th:text="${pageNum + 1}">1</button>
            </span>
            
            <button th:if="${currentPage < totalPages - 1}" 
                    th:onclick="'location.href=\'/member/mgmt?page=' + (${currentPage} + 1) + '\''">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

</div>

<div layout:fragment="script">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {

            document.querySelectorAll('.btn-save').forEach(button => {
                button.addEventListener('click', function() {
                    const memberNum = this.dataset.memberNum;
                    const roleSelect = document.querySelector(`select[data-member-num="${memberNum}"]`);
                    const newRole = roleSelect.value;
                    
                    if (!confirm('ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        return;
                    }

                    fetch('/member/update-role', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `memberNum=${memberNum}&memberRole=${newRole}`
                    })
                    .then(response => response.text())
                    .then(result => {
                        if (result === 'success') {
                            alert('ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            location.reload();
                        } else {
                            alert('ê¶Œí•œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch(error => {
                        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
                });
            });
        });


        document.addEventListener('DOMContentLoaded', () => {
            const screenMaxWidth = window.innerWidth * 0.9;
            const screenMaxHeight = window.innerHeight * 0.9;

            document.querySelectorAll('.col-image img').forEach(img => {
                img.addEventListener('click', () => {
                    const src = img.dataset.full || img.src;

                    const tempImg = new Image();
                    tempImg.src = src;
                    tempImg.onload = () => {
                        let w = tempImg.width;
                        let h = tempImg.height;

                        if (w > screenMaxWidth) {
                            h = h * (screenMaxWidth / w);
                            w = screenMaxWidth;
                        }
                        if (h > screenMaxHeight) {
                            w = w * (screenMaxHeight / h);
                            h = screenMaxHeight;
                        }

                        const left = (window.innerWidth - w) / 2 + window.screenX;
                        const top = (window.innerHeight - h) / 2 + window.screenY;

                        window.open(
                            src,
                            '_blank',
                            `width=${Math.round(w)},height=${Math.round(h)},left=${Math.round(left)},top=${Math.round(top)},resizable=yes,scrollbars=yes`
                        );
                    };
                });
            });
        });
    </script>
</div>

</body>
</html>
